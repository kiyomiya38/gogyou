// diagnose.jsï¼ˆå®Œå…¨çµ±åˆç‰ˆï¼šè³ªå•è£œæ­£ãƒ»ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆãƒ»ç›¸æ€§ãƒ»è·æ¥­ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒ»HTMLæç”»ï¼‰
const { Lunar } = require('lunar-javascript');

const stemMap = {
  'ç”²': ['æœ¨', 'é™½'], 'ä¹™': ['æœ¨', 'é™°'],
  'ä¸™': ['ç«', 'é™½'], 'ä¸': ['ç«', 'é™°'],
  'æˆŠ': ['åœŸ', 'é™½'], 'å·±': ['åœŸ', 'é™°'],
  'åºš': ['é‡‘', 'é™½'], 'è¾›': ['é‡‘', 'é™°'],
  'å£¬': ['æ°´', 'é™½'], 'ç™¸': ['æ°´', 'é™°']
};

const traitSummary = {
  'æœ¨-é™½': 'æˆé•·åŠ›ãŒé«˜ãã€å¤–å‘çš„ãªä¼ç”»ææ¡ˆå‹ã€‚äººã‚’å·»ãè¾¼ã¿ã€çµ„ç¹”ã‚’æ´»æ€§åŒ–ã•ã›ã‚‹æ¨é€²åŠ›ãŒã‚ã‚Šã¾ã™ã€‚',
  'æœ¨-é™°': 'æŸ”è»Ÿæ€§ã¨èª¿å’Œã‚’é‡ã‚“ã˜ã€æ•™è‚²ã‚„æ”¯æ´ã‚’é€šã˜ã¦äººã‚’è‚²ã¦ã‚‹ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚',
  'ç«-é™½': 'æƒ…ç†±çš„ã§ç›®ç«‹ã¤å­˜åœ¨ã€‚ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„æƒ³ã„ã‚’å½¢ã«ã—ã¦å‘¨å›²ã‚’é¼“èˆã™ã‚‹ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ãªã‚¿ã‚¤ãƒ—ã€‚',
  'ç«-é™°': 'é™ã‹ã«ç‡ƒãˆã‚‹æƒ…ç†±ã®æŒã¡ä¸»ã€‚è£æ–¹ã§äººã‚’æ”¯ãˆãªãŒã‚‰ã€çµ„ç¹”ã®é›°å›²æ°—ã‚’æ¸©ã‚ã‚‹ãƒ ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚«ãƒ¼ã€‚',
  'åœŸ-é™½': 'å®Ÿè¡ŒåŠ›ãŒã‚ã‚Šã€è¡Œå‹•ã§å®‰å®šã‚’ç”Ÿã¿å‡ºã™ç¾å ´ãƒªãƒ¼ãƒ€ãƒ¼ã€‚ä¿¡é ¼æ„Ÿã§å‘¨å›²ã‚’ã¾ã¨ã‚ã¾ã™ã€‚',
  'åœŸ-é™°': 'å…±æ„ŸåŠ›ã¨é…æ…®ã«å„ªã‚Œã€ç¸ã®ä¸‹ã®åŠ›æŒã¡ã¨ã—ã¦äººã¨äººã‚’ã¤ãªãèª¿æ•´å½¹ã«æœ€é©ã€‚',
  'é‡‘-é™½': 'æ­£ç¾©æ„Ÿã¨åˆ¤æ–­åŠ›ã§ãƒ«ãƒ¼ãƒ«ã‚„ä»•çµ„ã¿ã‚’æ•´ãˆã‚‹çµ±ç‡è€…ã€‚æ•´å‚™ã‚„è¦å¾‹ã«å¼·ãã€çµ±ç‡åŠ›ãŒã‚ã‚Šã¾ã™ã€‚',
  'é‡‘-é™°': 'å‡ å¸³é¢ã§æ…é‡ã€‚å“è³ªã‚„å®‰å…¨ã‚’å®ˆã‚‹å°‚é–€å®¶ã€‚ç´°éƒ¨ã«ç›®ãŒå±Šãã€å®‰å¿ƒæ„Ÿã‚’æä¾›ã—ã¾ã™ã€‚',
  'æ°´-é™½': 'æƒ…å ±ã‚„çŸ¥è­˜ã‚’åºƒã‚ã‚‹ã“ã¨ãŒå¾—æ„ãªä¼é“å¸«ã‚¿ã‚¤ãƒ—ã€‚æ–°æŠ€è¡“ã‚„æƒ…å ±ã‚’ä¼ãˆã‚‹ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚',
  'æ°´-é™°': 'æ·±ãé™ã‹ã«æ¢æ±‚ã™ã‚‹å†…çœå‹ã®ç ”ç©¶è€…ã€‚ç¶™ç¶šåŠ›ãŒã‚ã‚Šã€çŸ¥çš„åˆ†é‡ã§åŠ›ã‚’ç™ºæ®ã—ã¾ã™ã€‚'
};

const jobReasons = {
  'æœ¨': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’è¨­è¨ˆã™ã‚‹è·ç¨®ã‚„ã€å‰µé€ çš„ãªåˆ†é‡ï¼ˆUI/UXã€ä¼ç”»è·ï¼‰ã§åŠ›ã‚’ç™ºæ®ã§ãã¾ã™ã€‚',
  'ç«': 'ãƒãƒ¼ãƒ ã‚’é¼“èˆã™ã‚‹ç™ºä¿¡åŠ›ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹å½¹å‰²ï¼ˆæŠ€è¡“åºƒå ±ã€ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰ã«å‘ã„ã¦ã„ã¾ã™ã€‚',
  'åœŸ': 'ç¶™ç¶šçš„ãªé‹ç”¨ãƒ»ç›£è¦–ãªã©ã€å®‰å®šã‚’é‡è¦–ã—ãŸç¾å ´ã§ã®ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã«å‘ã„ã¦ã„ã¾ã™ã€‚',
  'é‡‘': 'å“è³ªã‚„æ§‹é€ ã‚’æ•´ãˆã‚‹ä»•äº‹ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€å“è³ªä¿è¨¼ï¼‰ã§å®ŸåŠ›ã‚’ç™ºæ®ã—ã¾ã™ã€‚',
  'æ°´': 'ç ”ç©¶é–‹ç™ºã‚„AIã€ãƒ‡ãƒ¼ã‚¿è§£æãªã©ã€çŸ¥çš„æ¢ç©¶ã¨é›†ä¸­åŠ›ãŒå¿…è¦ãªé ˜åŸŸã§æ´»èºã§ãã¾ã™ã€‚'
};

const jobs = {
  'æœ¨': [
    { title: 'UI/UXãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼', desc: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’è¨­è¨ˆã™ã‚‹è·ç¨®ã€‚æ„Ÿæ€§ã¨æ§‹é€ è¨­è¨ˆã®ä¸¡ç«‹ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚' },
    { title: 'ä¼ç”»è·ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', desc: 'ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®æ–¹å‘æ€§ã‚„æ§‹æƒ³ã‚’æãä¸Šæµå·¥ç¨‹ã«é–¢ä¸ã—ã¾ã™ã€‚' }
  ],
  'ç«': [
    { title: 'Developer Advocate', desc: 'æŠ€è¡“ã‚’å¤–ã«ä¼ãˆã‚‹ä»•äº‹ã€‚ç™»å£‡ãƒ»åŸ·ç­†ãƒ»SNSãªã©å¤šæ§˜ãªç™ºä¿¡ã§é–‹ç™ºè€…ã¨ã¤ãªãŒã‚Šã¾ã™ã€‚' },
    { title: 'ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰', desc: 'æŠ€è¡“é¢ã§ãƒãƒ¼ãƒ ã‚’å…ˆå°ã™ã‚‹å½¹å‰²ã€‚ä¿¡é ¼ã¨æƒ…ç†±ã§ç‰½å¼•ã—ã¾ã™ã€‚' }
  ],
  'åœŸ': [
    { title: 'SREï¼ˆSite Reliability Engineerï¼‰', desc: 'ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šç¨¼åƒã‚’ç›£è¦–ãƒ»æ”¹å–„ã™ã‚‹å°‚é–€è·ã€‚ç¾å ´å‹ã®ä¿¡é ¼ã‚’ç¯‰ãã¾ã™ã€‚' },
    { title: 'ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', desc: 'ã‚µãƒ¼ãƒãƒ¼ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ§‹ç¯‰ã¨ä¿å®ˆã‚’æ‹…å½“ã—ã¾ã™ã€‚' }
  ],
  'é‡‘': [
    { title: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', desc: 'å®‰å…¨æ€§ã‚„è¦å¾‹ã‚’å®ˆã‚‹ä»•äº‹ã€‚ãƒ«ãƒ¼ãƒ«æ•´å‚™ã‚„ãƒªã‚¹ã‚¯ç®¡ç†ã«å¼·ã¿ãŒã‚ã‚Šã¾ã™ã€‚' },
    { title: 'QAã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', desc: 'å“è³ªã‚’æ‹…ä¿ã™ã‚‹å°‚é–€å®¶ã€‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚„æ”¹å–„ç­–ã‚’æ•´å‚™ã—ã¾ã™ã€‚' }
  ],
  'æ°´': [
    { title: 'AIã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', desc: 'äººå·¥çŸ¥èƒ½ã®å®Ÿè£…ã‚’æ‹…ã†æŠ€è¡“è€…ã€‚ãƒ‡ãƒ¼ã‚¿ã¨å‘ãåˆã„ã€å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚' },
    { title: 'ç ”ç©¶è·ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', desc: 'æ–°æŠ€è¡“ã‚’æ¢æ±‚ã™ã‚‹è·ç¨®ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„è«–æ–‡ã‚’èª­ã¿è¾¼ã¿çŸ¥è¦‹ã‚’è“„ç©ã—ã¾ã™ã€‚' }
  ]
};

const compatibility = {
  'æœ¨': { love: 'ç«', conflict: 'é‡‘' },
  'ç«': { love: 'åœŸ', conflict: 'æ°´' },
  'åœŸ': { love: 'é‡‘', conflict: 'æœ¨' },
  'é‡‘': { love: 'æ°´', conflict: 'ç«' },
  'æ°´': { love: 'æœ¨', conflict: 'åœŸ' }
};

const decadeAdvice = {
  'æœ¨': ['è‡ªç„¶ä½“ã§å­¦ã¶', 'ç™ºå±•çš„ã«å­¦ã¶', 'æˆé•·æ”¯æ´ã«å›ã‚‹', 'ãƒªãƒ¼ãƒ€ãƒ¼ãƒ»æ•™è‚²å½¹'],
  'ç«': ['ç›®ç«‹ã¡å§‹ã‚ã‚‹', 'ä¼ãˆã‚‹åŠ›ã‚’è‚²ã¦ã‚‹', 'æƒ…ç†±ã®èª¿æ•´', 'ä¼æ‰¿ãƒ»ç™ºä¿¡å½¹'],
  'åœŸ': ['å®‰å®šæ€§ã‚’è‚²ã¦ã‚‹', 'è²¬ä»»æ„Ÿã‚’å¼·ã‚ã‚‹', 'çµ„ç¹”ã‚’æ”¯ãˆã‚‹', 'ã¾ã¨ã‚å½¹ãƒ»åœ°ç›¤'],
  'é‡‘': ['å‡ å¸³é¢ã•è‚²ã‚€', 'è«–ç†ã¨ç²¾åº¦ã‚’é›ãˆã‚‹', 'å°‚é–€æ€§ã‚’æ·±ã‚ã‚‹', 'æ§‹é€ åŒ–ãƒ»ç›£ç£å½¹'],
  'æ°´': ['èˆˆå‘³ã‚’æ¢ã™', 'çŸ¥è­˜ã‚’å¸å', 'æ·±æ˜ã‚Šå‹ã«è»¢æ›', 'ç ”ç©¶ãƒ»æ•™ãˆã‚‹ç«‹å ´']
};

function getDiagnosis(year, month, day, answers = {}) {
  const lunar = Lunar.fromYmdHms(year, month, day, 12, 0, 0);
  const eightChar = lunar.getEightChar();

  const yearGan = eightChar.getYearGan();
  const monthGan = eightChar.getMonthGan();
  const dayGan = eightChar.getDayGan();

  const [mainElem, mainYinYang] = stemMap[dayGan] || ['ä¸æ˜', '']
  const [yearElem] = stemMap[yearGan] || ['']
  const [monthElem] = stemMap[monthGan] || ['']

  const scores = { æœ¨: 0, ç«: 0, åœŸ: 0, é‡‘: 0, æ°´: 0 };
  if (scores[yearElem] !== undefined) scores[yearElem] += 10;
  if (scores[monthElem] !== undefined) scores[monthElem] += 40;
  if (scores[mainElem] !== undefined) scores[mainElem] += 50;

  for (const elem of ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']) {
    if (answers[elem]) {
      scores[elem] += answers[elem];
    }
  }

  const traitKey = `${mainElem}-${mainYinYang}`;
  const jobHTML = jobs[mainElem]?.map(j => `<li><strong>${j.title}</strong><br><small>${j.desc}</small></li>`).join('') || '';

  return {
    mainElem,
    mainYinYang,
    yearGan,
    monthGan,
    dayGan,
    yearElem,
    monthElem,
    traitComment: traitSummary[traitKey] || 'ç‰¹æ€§æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚',
    jobReason: jobReasons[mainElem] || '',
    jobHTML,
    compat: compatibility[mainElem] || {},
    growthAdvice: decadeAdvice[mainElem] || [],
    scores,
    balanceComment: getBalanceComment(scores)
  };
}

function getBalanceComment(scores) {
  const comments = [];
  const suggestions = {
    'æœ¨': {
      low: 'ğŸŒ± æœ¨ãŒä¸è¶³ â†’ æ–°ã—ã„ã“ã¨ã¸ã®æŒ‘æˆ¦ãŒå¼±ã¾ã‚ŠãŒã¡ã§ã™ã€‚å‰µé€ çš„ãªä»²é–“ã¨é–¢ã‚ã‚‹ã“ã¨ã§åˆºæ¿€ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚',
      high: 'ğŸŒ² æœ¨ãŒå¼·ã„ â†’ ç™ºæƒ³åŠ›ãŒè±Šã‹ã§ã™ã€‚å‘¨å›²ã®å…±æ„Ÿã‚„å®Ÿç¾åŠ›ã¨é€£æºã™ã‚‹ã¨ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¾ã™ã€‚'
    },
    'ç«': {
      low: 'ğŸ”¥ ç«ãŒä¸è¶³ â†’ ç†±æ„ã‚„æ„Ÿæƒ…è¡¨ç¾ãŒæ§ãˆã‚ã«ãªã‚ŠãŒã¡ã€‚å…±æ„Ÿã‚„å¯¾è©±ã®ã‚ã‚‹å ´ã«èº«ã‚’ç½®ãã¨è‰¯ã„ã§ã™ã€‚',
      high: 'ğŸ”¥ ç«ãŒå¼·ã„ â†’ æ¨é€²åŠ›ã¨æƒ…ç†±ã‚’æŒã¡ã¾ã™ãŒã€æš´èµ°ã›ãšå†·é™ã•ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚'
    },
    'åœŸ': {
      low: 'ğŸª¨ åœŸãŒä¸è¶³ â†’ å®‰å®šæ€§ã«æ¬ ã‘ã‚‹å‚¾å‘ã€‚åœ°é“ãªç©ã¿é‡ã­ã‚„ã€ç¾å®Ÿçš„ãªè¦–ç‚¹ã‚’å­¦ã¶ç’°å¢ƒãŒåˆã„ã¾ã™ã€‚',
      high: 'ğŸ§± åœŸãŒå¼·ã„ â†’ å®‰å¿ƒæ„Ÿã‚’ä¸ãˆã‚‹å­˜åœ¨ã§ã™ã€‚é ‘å›ºã«ãªã‚‰ãšæŸ”è»Ÿãªå§¿å‹¢ã‚’ä¿ã¡ã¾ã—ã‚‡ã†ã€‚'
    },
    'é‡‘': {
      low: 'âš™ï¸ é‡‘ãŒä¸è¶³ â†’ ãƒ«ãƒ¼ãƒ«ã‚„ç§©åºã«å¼±ã•ãŒå‡ºã‚‹ã“ã¨ã‚‚ã€‚æ§‹é€ åŒ–ã•ã‚ŒãŸæ€è€ƒã‚’å–ã‚Šå…¥ã‚Œã‚‹ã¨å®‰å®šã—ã¾ã™ã€‚',
      high: 'ğŸª™ é‡‘ãŒå¼·ã„ â†’ åˆ†æã¨æ•´å‚™ã«å„ªã‚Œã¾ã™ã€‚éå‰°ãªå®Œç’§ä¸»ç¾©ã«ã¯æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚'
    },
    'æ°´': {
      low: 'ğŸ’§ æ°´ãŒä¸è¶³ â†’ æƒ…å ±å‡¦ç†ã‚„å­¦ç¿’ã®ãƒšãƒ¼ã‚¹ãŒè½ã¡ãŒã¡ã€‚é™ã‹ãªæ™‚é–“ã¨èª­æ›¸ãŒè£œå®Œã«ãªã‚Šã¾ã™ã€‚',
      high: 'ğŸŒŠ æ°´ãŒå¼·ã„ â†’ æ¢ç©¶åŠ›ãŒéš›ç«‹ã¡ã¾ã™ãŒã€ç¾å®Ÿã¨ã®ãƒãƒ©ãƒ³ã‚¹ã‚‚å¿˜ã‚Œãšã«ã€‚'
    }
  };
  for (const [elem, score] of Object.entries(scores)) {
    if (score < 20) comments.push(suggestions[elem].low);
    else if (score >= 80) comments.push(suggestions[elem].high);
    else if (score >= 50) comments.push(`âœ… ${elem}ãŒååˆ†ã«ã‚ã‚Šã¾ã™ â†’ ${suggestions[elem].high.replace(/^[^â†’]+â†’ /, '')}`);
  }
  return comments.join('<br>') || 'äº”è¡Œã®ãƒãƒ©ãƒ³ã‚¹ã¯æ¯”è¼ƒçš„ä¸­åº¸ã§ã™ã€‚';
}

function renderHtml(data) {
  const ageLabels = ['10ä»£ã¾ã§', '20ã€œ30ä»£', '40ã€œ50ä»£', '60ä»£ä»¥é™'];
  const adviceHTML = data.growthAdvice.map((a, i) => `<li><strong>${ageLabels[i]}ï¼š</strong>${a}</li>`).join('');

  return `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>äº”è¡Œè¨ºæ–­çµæœ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; line-height: 1.6; margin: 2em; }
    .chart-container { max-width: 400px; margin: 2em auto; }
  </style>
</head>
<body>
  <h1>ã‚ãªãŸã®äº”è¡Œã‚¿ã‚¤ãƒ—è¨ºæ–­çµæœ</h1>
  <p><strong>æ—¥å¹²ï¼š</strong>${data.dayGan}ï¼ˆ${data.mainElem}ãƒ»${data.mainYinYang}ï¼‰</p>
  <p>${data.traitComment}</p>
  <p><strong>æœˆå¹²ï¼š</strong>${data.monthGan}ï¼ˆ${data.monthElem}ï¼‰</p>
  <p><strong>å¹´å¹²ï¼š</strong>${data.yearGan}ï¼ˆ${data.yearElem}ï¼‰</p>
  <hr>
  <h2>äº”è¡Œã‚¹ã‚³ã‚¢</h2>
  <div class="chart-container">
    <canvas id="radarChart"></canvas>
  </div>
  <h2>äº”è¡Œãƒãƒ©ãƒ³ã‚¹ã‚³ãƒ¡ãƒ³ãƒˆ</h2>
  <p>${data.balanceComment}</p>
  <hr>
  <h2>ç›¸æ€§å‚¾å‘</h2>
  <p>ç›¸æ€§ã®è‰¯ã„ã‚¿ã‚¤ãƒ—ï¼š<strong>${data.compat.love || 'ä¸æ˜'}</strong><br>
     è‹¦æ‰‹ãªã‚¿ã‚¤ãƒ—ï¼š<strong>${data.compat.conflict || 'ä¸æ˜'}</strong></p>
  <hr>
  <h2>å¹´ä»£åˆ¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h2>
  <ul>${adviceHTML}</ul>
  <hr>
  <h2>å‘ã„ã¦ã„ã‚‹è·ç¨®</h2>
  <p>${data.jobReason}</p>
  <ul>${data.jobHTML}</ul>
  <script>
    const ctx = document.getElementById('radarChart').getContext('2d');
    new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'],
        datasets: [{
          label: 'äº”è¡Œã‚¹ã‚³ã‚¢',
          data: [${data.scores['æœ¨']}, ${data.scores['ç«']}, ${data.scores['åœŸ']}, ${data.scores['é‡‘']}, ${data.scores['æ°´']}],
          fill: true,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          pointBackgroundColor: 'rgb(75, 192, 192)'
        }]
      },
      options: {
        scales: {
          r: {
            min: 0,
            max: 100,
            ticks: { stepSize: 20 }
          }
        }
      }
    });
  </script>
</body>
</html>`;
}

module.exports = {
  getDiagnosis,
  getBalanceComment,
  renderHtml
};
